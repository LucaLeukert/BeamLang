import sh_args.*;

internal fn assert_mode(parsed: CliParsedArgs!String, mode: String, value: String, fail: number) -> number {
    return match (parsed) {
        case!ok info -> {
            guard (str_eq(info->mode, mode)) else { return fail; }
            guard (str_eq(info->value, value)) else { return fail + 100; }
            return 0;
        },
        case!err _ => fail
    };
}

internal fn assert_error(parsed: CliParsedArgs!String, fail: number) -> number {
    return match (parsed) {
        case!ok _ => fail,
        case!err _ => 0
    };
}

internal fn str_eq(left: String, right: String) -> bool {
    if (left->length() != right->length()) {
        return false;
    }
    return left->starts_with(right);
}

fn main(args: [String]) -> number {
    let r1 = assert_mode(parse_cli(["--help"]), "help", "", 1);
    guard (r1 == 0) else { return r1; }

    let r2 = assert_mode(parse_cli(["--version"]), "version", "", 2);
    guard (r2 == 0) else { return r2; }

    let r3 = assert_mode(parse_cli(["lex", "input.bl"]), "lex_file", "input.bl", 3);
    guard (r3 == 0) else { return r3; }

    let r4 = assert_mode(parse_cli(["lex", "--stdin"]), "lex_stdin", "", 4);
    guard (r4 == 0) else { return r4; }

    let r5 = assert_error(parse_cli(["--version", "extra"]), 5);
    guard (r5 == 0) else { return r5; }

    let r6 = assert_error(parse_cli(["unknown"]), 6);
    guard (r6 == 0) else { return r6; }

    return 0;
}
